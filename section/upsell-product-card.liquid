{%- comment -%}
UPSELL PRODUCT CARD SECTION
Used for AJAX loading of individual products
{%- endcomment -%}

{%- assign product = product -%}
{%- if product and product.available -%}
  {%- assign form_id = 'product-form-' | append: product.id | append: '-upsell' -%}
  {%- assign default_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media -%}
  {%- assign filtered_indexes = '' | split: ',' -%}
  
  {%- if product.variants.size > 1 -%}
    {%- for media in product.media -%}
      {%- if media.alt contains '#' and media.alt != product.title -%}
        {%- assign alt_parts = media.alt | split: '#' -%}
        {%- assign media_group_parts = alt_parts.last | split: '_' -%}
        {%- assign option = product.options_by_name[media_group_parts.first] -%}
        {%- if option -%}
          {%- assign option_value = option.selected_value | downcase | replace: '*', '' -%}
          {%- assign downcase_group_value = media_group_parts.last | strip | downcase -%}
          {%- if option_value != downcase_group_value and media != default_media -%}
            {%- assign filtered_indexes = filtered_indexes | append: media.position | append: ',' -%}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  <div class="upsell_product" id="upsell-product-{{ product.id }}" data-product-id="{{ product.id }}">
    <div class="line-item">
      <product-gallery class="product-gallery" form="{{ form_id }}">
        <div class="product-gallery__image-list">
          <div class="contents">
            <scroll-carousel class="product-gallery__carousel scroll-area upsell-product-gallery" role="region">
              {%- assign filtered_indexes_array = filtered_indexes | split: ',' -%}
              {%- for media in product.media -%}
                {%- assign media_position_str = media.position | string -%}
                {%- assign should_hide = false -%}
                
                {%- if media.alt == 'card-only' -%}
                  {%- assign show_card_only = false -%}
                  {%- assign selected_variant = product.selected_or_first_available_variant -%}
                  {%- unless selected_variant.featured_media -%}
                    {%- assign show_card_only = true -%}
                  {%- endunless -%}
                  {%- if selected_variant.featured_media.id == media.id -%}
                    {%- assign show_card_only = true -%}
                  {%- endif -%}
                  {%- unless show_card_only -%}
                    {%- assign should_hide = true -%}
                  {%- endunless -%}
                {%- endif -%}
                
                {%- if filtered_indexes_array contains media_position_str -%}
                  {%- assign should_hide = true -%}
                {%- endif -%}
                
                <div class="product-gallery__media upsell_media snap-center {% if media == default_media %}is-initial{% endif %}" 
                     data-media-type="{{ media.media_type }}" 
                     data-media-id="{{ media.id }}" 
                     data-media-position="{{ media.position }}"
                     role="group" 
                     {% if should_hide %}hidden{% endif %}>
                  {%- if media.media_type == 'image' -%}
                    <img src="{{ media | image_url: width: 400 }}" 
                         alt="{{ media.alt | escape }}"
                         width="400" 
                         height="400"
                         loading="lazy"
                         class="line-item__media"
                         style="object-fit: cover; width: 100%; height: auto;">
                  {%- else -%}
                    {%- render 'media', media: media, sizes: '400px', preload: false, controls: true, playsinline: true, muted: false, loop: false, group: 'upsell', class: 'line-item__media' -%}
                  {%- endif -%}
                </div>
              {%- endfor -%}
            </scroll-carousel>
          </div>
        </div>  
      </product-gallery>
      
      {%- assign title_length = product.title | size -%}
      <div class="line-item-info {% if title_length <= 24 %}long-title{% endif %}">
        <div class="line-item-info-content">
          <div class="v-stack justify-items-start gap-1">
            {%- case product.title -%}
              {%- when 'Compressible Packing Cubes (6 Pieces)' -%}
                <a href="{{ product.url }}" class="h6">Packing Cubes</a>
              {%- when 'Check-in: All-in-One 28"' -%}
                <a href="{{ product.url }}" class="h6">Check-in: All-in-One</a>
              {%- when 'Check-in: Aluminum 28"' -%}
                <a href="{{ product.url }}" class="h6">Check-in: Aluminum</a>
              {%- when 'Check-in Medium: All-in-One 24"' -%}
                <a href="{{ product.url }}" class="h6">Check-in Medium: All-in-One</a>
              {%- else -%}
                <a href="{{ product.url }}" class="h6">{{ product.title }}</a>
            {%- endcase -%}
          </div>
          {%- render 'price-list', variant: product.selected_or_first_available_variant, form_id: form_id, hide_unit_price: true, context: 'card' -%}
          {%- render 'variant-picker', product: product, form_id: form_id, update_url: false, hide_sold_out_variants: true, selector_type: 'color', color_selector_type: 'color' -%}
        </div> 
        {%- render 'buy-button-alt', product: product, form_id: form_id, show_payment_button: false -%}
      </div>
    </div>
  </div>
{%- endif -%}