{{ 'cart-upsell-section.css' | asset_url | stylesheet_tag }}
{%- assign upsell_products = section.settings.products -%}
{%- assign cart_product_ids = cart.items | map: 'product_id' -%}
{%- assign available_upsell_count = 0 -%}

{%- for recommended_product in upsell_products -%}
{%- assign product = recommended_product -%}
{%- if product.available and cart_product_ids contains product.id -%}
{%- continue -%}
{%- endif -%}

{%- if product.available -%}
{%- assign available_upsell_count = available_upsell_count | plus: 1 -%}
{%- endif -%}
{%- endfor -%}

{%- assign has_upsell = false -%}
{%- assign displayed_upsell_count = 0 -%}

{%- for cart_item in cart.items -%}
  {%- assign cart_upsell_products = cart_item.product.metafields.custom.cart_upsell_products.value -%}

  {%- for upsell_product in cart_upsell_products -%}
    {%- assign product = upsell_product -%}

    {%- if product.available and cart_product_ids contains product.id -%}
      {%- continue -%} {# Skip if the upsell product is already in the cart #}
    {%- endif -%}

    {%- assign displayed_upsell_count = displayed_upsell_count | plus: 1 -%}

    {%- if displayed_upsell_count > 0 -%}
      {%- assign has_upsell = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if has_upsell -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- if has_upsell -%}
<div class="cart-recommendations-container lang="{{ request.locale }}>
  <div class="cart-drawer__recommendations car-drawer-recommendation-carousel {% if cart.item_count == 1 %} one-item-left {% endif %}" id="recommendations-section">
    <h5 class="picked-for-you-title">{{ section.settings.recommendations_title }}</h5>

    <div class="cart-upsell-carousel-wrapper">
      <scroll-carousel class="cart-upsell-carousel" id="carousel" role="region">
        {% assign displayed_product_ids = "" %}
        {%- assign upsell_count = 0 -%}

        <!-- Loop through each cart item in the order they were added -->
        {%- for cart_item in cart.items -%}
          {%- assign cart_upsell_products = cart_item.product.metafields.custom.cart_upsell_products.value -%}

          <!-- Loop through upsell products for the current cart item -->
          {%- for upsell_product in cart_upsell_products -%}
            {%- assign product = upsell_product -%}

            <!-- Check if product is available -->
            {% if product.available %}
              <!-- Check if product is already in cart -->
              {% if cart_product_ids contains product.id %}
                {%- continue -%}
              {% endif %}

              <!-- Check if product has already been displayed -->
              {% if displayed_product_ids contains product.id %}
                {%- continue -%}
              {% endif %}

              <!-- Render upsell product if it hasn't been displayed yet -->
              {%- if upsell_count < 20 -%}
                      {%- capture form_id -%}product-form-{{ product.id }}-{{ section.id }}{%- endcapture -%}

                <div class="upsell_product" id="upsell-product-{{ product.id }}">
        <div class="line-item">
          {% liquid
          assign product_form_id = form_id
          assign default_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
          assign filtered_indexes = null | sort

          if product.variants.size > 1
            for media in product.media
              if media.alt contains '#' and media.alt != product.title
                assign alt_parts = media.alt | split: '#'
                assign media_group_parts = alt_parts.last | split: '_'
                assign option = product.options_by_name[media_group_parts.first]
                assign option_value = option.selected_value | downcase
                assign downcase_group_value = media_group_parts.last | strip | downcase

                if option_value != downcase_group_value and media != default_media
                  assign media_position = media.position | sort
                  assign filtered_indexes = filtered_indexes | concat: media_position
                endif
              endif
            endfor
          endif
        %}
         
          <product-gallery class="product-gallery" form="{{ product_form_id }}">
             
          <div class="product-gallery__image-list">
            <div class="contents">
              
                 
              <scroll-carousel class="product-gallery__carousel scroll-area upsell-product-gallery" role="region" id="carousel">
                {%- if product != blank -%}
                  {%- liquid
                    capture sizes
                      echo '(max-width: 699px) calc(100vw - 40px), (max-width: 999px) calc(100vw - 64px), '

                      assign media_ratio = 100 | minus: section.settings.product_info_size

                      if desktop_layout == 'grid_2x'
                        assign media_ratio = media_ratio | divided_by: 2
                      endif

                      if section.settings.container_size == 'full'
                        echo 'calc(' | append: media_ratio | append: 'vw - 96px)'
                      else
                        assign media_ratio = 1260 | times: media_ratio | divided_by: 100 | round

                        if desktop_layout == 'grid_2x'
                          assign maximum_width = '260px'
                        else
                          assign maximum_width = '1100px'
                        endif

                        echo 'min(' | append: maximum_width | append: ', ' | append: media_ratio | append: 'px - 96px)'
                      endif
                    endcapture
                  -%}

                  {%- for media in product.media -%}
                    <div
                      class="product-gallery__media upsell_media snap-center {% if media == default_media %}is-initial{% endif %}"
                      data-media-type="{{ media.media_type }}"
                      data-media-id="{{ media.id }}"
                      role="group"
                      aria-label="{{ 'general.accessibility.item_nth_of_count' | t: index: media.position, count: product.media.size }}"
                      {% if filtered_indexes contains media.position %}
                        hidden
                      {% endif %}
                    >
                      {%- if default_media == media -%}
                        {%- assign preload = false -%}
                      {%- else -%}
                        {%- assign preload = false -%}
                      {%- endif -%}

                      {%- comment -%}
                        NOTE: for the product gallery, the autoplay does not work in a similar way. It is always false at the product level,
                        and the product-gallery component itself will autoplay (if needed)
                      {%- endcomment -%}
                      {%- render 'media',
                        media: media,
                        sizes: sizes,
                        preload: preload,
                        controls: true,
                        playsinline: true,
                        muted: enable_media_autoplay,
                        loop: enable_video_looping,
                        group: 'product',
                        class: 'line-item__media'
                      -%}
                    </div>
                  {%- endfor -%}
                {%- else -%}
                  {%- for i in (1..3) -%}
                    {%- capture placeholder_name -%}product-{{ i }}{%- endcapture -%}

                    <div
                      class="product-gallery__media upsell_media snap-center {% if forloop.first %}is-initial{% endif %}"
                      data-media-type="{{ media.media_type }}"
                      data-media-position="{{ media.position }}"
                      data-media-id="{{ media.id }}"
                      role="group"
                      aria-label="{{ 'general.accessibility.item_nth_of_count' | t: index: forloop.index, count: 3 }}"
                    >
                      {{- placeholder_name | placeholder_svg_tag: 'placeholder' -}}
                    </div>
                  {%- endfor -%}
                {%- endif -%}
              </scroll-carousel>
                      
                   
            </div>
          </div>
        <!-- Add the navigation arrows -->
                    
                 

                  
        </product-gallery>
        
          {%- assign title_length = product.title | size -%}
          <div class="line-item-info {% if title_length <= 24  %} long-title {% endif %}">
            <div class="line-item-info-content">
            <div class="v-stack justify-items-start gap-1">
              {% case product.title %}
              {% when 'Compressible Packing Cubes (6 Pieces)' %}
               <a href="{{ product.url }}" class="h6">Packing Cubes</a>
                {% when 'Check-in: All-in-One 28"' %}
               <a href="{{ product.url }}" class="h6">Check-in: All-in-One</a>
                {% when 'Check-in: Aluminum 28"' %}
               <a href="{{ product.url }}" class="h6">Check-in: Aluminum</a>
              {% else %}
               <a href="{{ product.url }}" class="h6">{{ product.title }}</a>
              {% endcase %}
            </div>
            {%- render 'price-list',
            variant: product.selected_or_first_available_variant,
            form_id: form_id,
            hide_unit_price: true,
            context: 'card'
            -%}
            <!-- Variant Picker -->
            {%- render 'variant-picker', product: product, form_id: form_id, update_url: false, hide_sold_out_variants: true, selector_type: 'color', color_selector_type: 'color' -%}
            </div>
            
            {%- render 'buy-button-alt', product: product, form_id: form_id, show_payment_button: false -%}
          </div>
        </div>
                </div>

                <!-- Track displayed product ID to avoid duplication -->
                {%- assign displayed_product_ids = displayed_product_ids | append: product.id | append: "," -%}
                {%- assign upsell_count = upsell_count | plus: 1 -%}
              {%- endif -%}
            {% endif %}
          {%- endfor -%}

        {%- endfor -%}
      </scroll-carousel>

      <!-- Carousel navigation arrows -->
      {% if upsell_count > 1 %}
        <button is="carousel-prev-button" type="button" class="carousel-arrows-upsell prev-next-button prev-next-button--prev circle-button hover:animate-icon-inline" aria-controls="carousel" disabled>
          <span class="sr-only">{{ 'general.accessibility.previous' | t }}</span>
          {%- render 'icon' with 'arrow-left', direction_aware: true -%}
        </button>
        <button is="carousel-next-button" type="button" class="carousel-arrows-upsell prev-next-button prev-next-button--next circle-button hover:animate-icon-inline" aria-controls="carousel">
          <span class="sr-only">{{ 'general.accessibility.next' | t }}</span>
          {%- render 'icon' with 'arrow-right', direction_aware: true -%}
        </button>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}