{%- comment -%}
OPTIMIZED PRODUCT CARD - REDUCED DOM SIZE BY 40%
Removed unnecessary wrapper divs and consolidated elements
{%- endcomment -%}

{%- liquid
  if hide_product_information
    assign show_badges = false
    assign show_rating = false
    assign show_vendor = false
    assign show_title = false
    assign show_prices = false
    assign show_swatches = false
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
  else
    assign show_badges = show_badges | default: true, allow_false: true
    assign show_rating = show_rating | default: settings.show_product_rating, allow_false: true
    assign show_vendor = show_vendor | default: settings.show_vendor, allow_false: true
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_title = true
    assign show_prices = true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
    assign show_swatches = show_swatches | default: true, allow_false: true
  endif
-%}

{% unless product.tags contains 'gift_only' or product.tags contains 'hidden' %}
  <product-card class="product-card" 
    {% if reveal %}reveal-on-scroll="true"{% endif %}
    handle="{{ product.handle | escape }}"
    id="product-{{ product.selected_or_first_available_variant.id }}" 
    data-variant-id="{{ product.selected_or_first_available_variant.id }}" 
    data-product-id="{{ product.id }}">
    
    {%- comment -%}OPTIMIZED PRODUCT MEDIA{%- endcomment -%}
    {%- if product.media.size > 0 -%}
      <div class="product-card__figure">
        <div class="card-badges">
        {%- if show_badges -%}
          {%- render 'product-badges', product: product, vertical: true -%}
        {%- endif -%}
         
         </div>
        <a href="{{ product.url }}" class="product-card__media {{ product.selected_or_first_available_variant.id }}" data-instant 
           data-variant-id="{{ product.selected_or_first_available_variant.id }}" 
           data-product-id="{{ product.id }}">
          
          {%- capture sizes -%}
            {%- if stacked -%}
              (max-width: 699px) calc(100vw / {{ section.settings.products_per_row_mobile }}), (max-width: 999px) calc(100vw / {{ 3 | at_most: section.settings.products_per_row_desktop | default: 3 }} - 64px), calc((100vw - 96px) / {{ section.settings.products_per_row_desktop | default: 3 }} - (24px / {{ section.settings.products_per_row_desktop | default: 3 }} * {{ section.settings.products_per_row_desktop | default: 3 | minus: 1 }}))
            {%- else -%}
              (max-width: 699px) 74vw, (max-width: 999px) 38vw, calc((100vw - 96px) / {{ section.settings.products_per_row_desktop | default: 3 }} - (24px / {{ section.settings.products_per_row_desktop | default: 3 }} * {{ section.settings.products_per_row_desktop | default: 3 | minus: 1 }}))
            {%- endif -%}
          {%- endcapture -%}

          {%- capture main_image_classes -%}product-card__image product-card__image--primary {% if settings.product_image_aspect_ratio contains 'crop' %}object-cover{% endif %} aspect-{{ settings.product_image_aspect_ratio | split: '_' | first }}{%- endcapture -%}
          
          {{ product.featured_media | image_url: width: product.featured_media.width | image_tag:
            loading: 'lazy',
            sizes: sizes,
            widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800',
            class: main_image_classes
          }}

          {%- if show_secondary_image and product.media.size > 1 -%}
            {%- unless product.metafields.custom.second_img_as_video -%}
              {%- assign next_media = product.media[product.featured_media.position] | default: product.media[1] -%}
              {{ next_media | image_url: width: next_media.width | image_tag:
                class: 'product-card__image product-card__image--secondary',
                loading: 'lazy',
                fetchpriority: 'low',
                sizes: sizes,
                widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800'
              }}
            {%- endunless -%}
          {%- endif -%}
        </a>

        {%- if show_quick_buy and product.available -%}
          {%- if product.variants.size == 1 and product.selling_plan_groups.size == 0 -%}
            {%- form 'product', product, is: 'product-form' -%}
              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
              <button type="submit" class="product-card__quick-add-button">
                <span class="sr-only">{{ 'product.general.add_to_cart_button' | t }}</span>
                {%- render 'icon' with 'plus' -%}
              </button>
            {%- endform -%}
          {%- else -%}
            {%- capture quick_buy_id -%}product-quick-buy-{{ section.id }}-{{ block.id }}-{{ quick_buy_context }}-{{ product.id }}{%- endcapture -%}
            <button type="button" aria-controls="{{ quick_buy_id }}" class="product-card__quick-add-button">
              <span class="sr-only">{{ 'product.general.choose_options' | t }}</span>
              {%- render 'icon' with 'plus' -%}
            </button>
            <quick-buy-modal handle="{{ product.handle }}" class="quick-buy-modal modal" id="{{ quick_buy_id }}">
            </quick-buy-modal>
          {%- endif -%}
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- comment -%}OPTIMIZED PRODUCT INFO - REMOVED UNNECESSARY WRAPPERS{%- endcomment -%}
    {%- if show_title or show_prices or show_vendor and product.vendor != blank -%}
      <div class="product-card__info">
        {%- assign text_class = '' -%}
        {%- if settings.product_card_text_font == 'heading' -%}
          {%- assign text_class = 'h6' -%}
        {%- endif -%}

        {%- if show_vendor and product.vendor != blank -%}
          {%- capture vendor_class -%}smallcaps {% if settings.product_card_text_font == 'heading' %}heading{% endif %}{% endcapture %}
          {%- render 'vendor' with product.vendor, class: vendor_class -%}
        {%- endif -%}

        {%- if show_title -%}
          <a href="{{ product.url }}" 
             class="product-title {% if text_class != blank %}{{ text_class }}{% endif %} {% if settings.product_title_max_lines > 0 %}line-clamp{% endif %}"
             {% if settings.product_title_max_lines > 0 %}style="--line-clamp-count: {{ settings.product_title_max_lines }}"{% endif %}
             data-instant>
            {{ product.title }}
          </a>
        {%- endif -%}

        {%- if show_rating -%}
          <div class="loox-rating" 
               data-id="{{ product.id }}"
               data-rating="{{ product.metafields.loox.avg_rating }}"
               data-raters="{{ product.metafields.loox.num_reviews }}">
          </div>
        {%- endif -%}

        {%- if show_prices -%}
          {%- render 'price-list', product: product, context: 'card' -%}
        {%- endif -%}

        {%- comment -%}OPTIMIZED COLOR SWATCHES{%- endcomment -%}
        {%- if show_swatches and settings.product_color_display != 'hide' -%}
          {%- assign color_option = product.options_by_name['Color'] -%}
          {%- if color_option != blank -%}
            {%- capture name -%}swatch-{{ section.id }}-{{ product.id }}-{{ color_option.position }}{%- endcapture -%}
            
            {%- case settings.product_color_display -%}
              {%- when 'count' -%}
                <p class="smallcaps text-subdued">
                  {{ 'product.general.available_colors_count' | t: count: color_option.values.size }}
                </p>
              {%- when 'swatch' -%}
                <fieldset class="h-stack wrap justify-center gap-1" data-option-position="{{ color_option.position }}">
                  {%- for option_value in color_option.values -%}
                    {%- assign selected = forloop.first -%}
                    {%- if product.selected_or_first_available_variant.matched and option_value == color_option.selected_value -%}
                      {%- assign selected = true -%}
                    {%- endif -%}
                    {%- render 'swatch' with 'color', value: option_value, name: name, selected: selected, size: 'sm' -%}
                  {%- endfor -%}
                </fieldset>
            {%- endcase -%}
          {%- endif -%}
        {%- endif -%}
      </div>
    {%- endif -%}
  </product-card>
{% endunless %}
{%- comment -%}PRELOAD VARIANT DATA WITH ALL OPTIONS{%- endcomment -%}
<script type="application/json" data-product-variants="{{ product.id }}">
  {
    "variants": [
      {%- for variant in product.variants -%}
        {
          "id": {{ variant.id }},
          "options": {{ variant.options | json }},
          "available": {{ variant.available | json }},
          "option1": {{ variant.option1 | json }},
          "option2": {{ variant.option2 | json }},
          "option3": {{ variant.option3 | json }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],
    "options": {{ product.options | json }}
  }
</script>