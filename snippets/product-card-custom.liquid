{%- comment -%}
  ----------------------------------------------------------------------------------------------------------------------
  PRODUCT CARD COMPONENT
  ----------------------------------------------------------------------------------------------------------------------

  This component is used in collection and featured collection to render a single product as a card

  ********************************************
  Supported variables
  ********************************************

  * product: the product to render
  * stacked: define if the product is stacked or not on mobile
  * reveal: if set to true, the card will be revealed on scroll through animation
  * show_badges: show or not the badges (default to true if nothing is set).
  * show_rating: show or not the rating. If nothing is set, the theme uses the default product card setting
  * show_vendor: show or not the vendor. If nothing is set, the theme uses the default product card setting
  * show_quick_buy: show or not the quick buy (which open a modal if the product contains more than 1 choice)
  * show_secondary_image: show or not the secondary media on hover. If nothing is set, the theme uses the default product card setting
  * show_swatches: show or not the swatches. The swatch type is inferred from setting, and will default to true if nothing is set.
  * hide_product_information: if set to true, all content (vendor, badge, title...) are not rendered, to create image-based grid
  * quick_buy_context: a unique text to dissociate quick buy if the same product is embedded multiple times
{%- endcomment -%}

{%- liquid
  if hide_product_information
    assign show_badges = false
    assign show_rating = false
    assign show_vendor = false
    assign show_title = false
    assign show_prices = false
    assign show_swatches = false
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
  else
    assign show_badges = show_badges | default: true, allow_false: true
    assign show_rating = show_rating | default: settings.show_product_rating, allow_false: true
    assign show_vendor = show_vendor | default: settings.show_vendor, allow_false: true
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_title = true
    assign show_prices = true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
    assign show_swatches = show_swatches | default: true, allow_false: true
  endif
-%}
{%- capture product_form_id -%}product-form-{{ product.id }}-{{ section.id }}{%- endcapture -%}
<product-card
  class="product-card"
  {% if reveal %}
    reveal-on-scroll="true"
  {% endif %}
  handle="{{ product.handle | escape }}"
>
  {%- comment -%}
    --------------------------------------------------------------------------------------------------------------------
    PRODUCT MEDIA
    --------------------------------------------------------------------------------------------------------------------
  {%- endcomment -%}

  
  {%- if product.media.size > 0 -%}
    <div class="product-card__figure">
      {%- if show_badges -%}
        {%- render 'product-badges', product: product, vertical: true -%}
      {%- endif -%}

      <a href="{{ product.url }}" class="product-card__media" data-instant>
         {%- render 'product-gallery',
          product: product
        -%}
      </a>
    </div>
  {%- endif -%}

  {%- comment -%}
    --------------------------------------------------------------------------------------------------------------------
    PRODUCT INFO
    --------------------------------------------------------------------------------------------------------------------
  {%- endcomment -%}

  <div class="product-card__info empty:hidden">
    {%- assign text_class = '' -%}

    {%- if settings.product_card_text_font == 'heading' -%}
      {%- assign text_class = 'h6' -%}
    {%- endif -%}

    {%- if show_title or show_prices or show_vendor and product.vendor != blank -%}
      <div class="v-stack justify-items-center gap-2">
        {%- if show_vendor and product.vendor != blank -%}
          {%- capture vendor_class -%}smallcaps {% if settings.product_card_text_font == 'heading' %}heading{% endif %}{% endcapture %}
          {%- render 'vendor' with product.vendor, class: vendor_class -%}
        {%- endif -%}

        {%- if show_title or show_prices -%}
          <div class="v-stack justify-items-center gap-1">
            {%- if show_title -%}
              <a
                href="{{ product.url }}"
                class="product-title {% if text_class != blank %}{{ text_class }}{% endif %} {% if settings.product_title_max_lines > 0 %}line-clamp{% endif %}"
                {% if settings.product_title_max_lines > 0 %}
                  style="--line-clamp-count: {{ settings.product_title_max_lines }}"
                {% endif %}
                data-instant
              >
                <b>{{- product.title -}}</b>
              </a>
            {%- endif -%}
            {%- if show_rating -%}
              <div
                class="loox-rating"
                data-id="{{ product.id }}"
                data-rating="{{ product.metafields.loox.avg_rating }}"
                data-raters="{{ product.metafields.loox.num_reviews }}"
                data-pattern="<b>+[count] reviews</b>"
              ></div>
              {% comment %}
                {%- render 'product-rating', product: product, show_empty: settings.show_product_rating_if_empty, display_mode: settings.product_rating_mode -%}
              {% endcomment %}
            {%- endif -%}

            {%- if show_prices -%}

              {%- render 'price-list', product: product, variant: product.selected_or_first_available_variant, context: 'product', form_id: product_form_id -%}

            {%- endif -%}
          </div>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- if show_swatches and settings.product_color_display != 'hide' -%}
      {%- assign color_label_list = 'general.label.color' | t | replace: ', ', ',' | downcase | split: ',' -%}
    
        {%- for color_label in color_label_list -%}
        
        {%- if product.options_by_name[color_label] != blank -%}
          {%- assign product_option = product.options_by_name[color_label] -%}
          {%- capture name -%}swatch-{{ section.id }}-{{ product.id }}-{{ product_option.position }}{%- endcapture -%}

          {%- case settings.product_color_display -%}
            {%- when 'count' -%}
              <p class="smallcaps text-subdued">
                {{- 'product.general.available_colors_count' | t: count: product_option.values.size -}}
              </p>

            {%- when 'swatch' -%}
              <fieldset class="h-stack wrap justify-center gap-1" data-option-position="{{ product_option.position }}">
                {%- for option_value in product_option.values -%}
                  {%- if forloop.first
                    or product.selected_or_first_available_variant.matched
                    and option_value == product_option.selected_value
                  -%}
                    {%- assign selected = true -%}
                  {%- else -%}
                    {% assign selected = false %}
                  {%- endif -%}

                  {%- render 'swatch' with 'color', value: option_value, name: name, selected: selected, size: 'sm' -%}
                {%- endfor -%}
              </fieldset>
          {%- endcase -%}

          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}

    {%- if show_rating -%}
      {% comment %}
        {%- render 'product-rating', product: product, show_empty: settings.show_product_rating_if_empty, display_mode: settings.product_rating_mode -%}
      {% endcomment %}
    {%- endif -%}

    {%- if show_quick_buy and product.available -%}
      {%- if product.variants.size == 1 and product.selling_plan_groups.size == 0 -%}
        <div form="{{ form_id }}" class=" ">
          {%-
            render 'buy-buttons',
            product: product,
            form_id: form_id,
            show_payment_button: false,
          -%}
        </div>

        {% comment %}
          {%- form 'product', product, is: 'product-form' -%}
              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
              <button type="submit" class="product-card__quick-add-button">
                <span class="sr-only">{{ 'product.general.add_to_cart_button' | t }}</span>
                {%- render 'icon' with 'plus' -%}
              </button>
            {%- endform -%}
        {% endcomment %}
      {%- else -%}
        {%- capture quick_buy_id -%}product-quick-buy-{{ section.id }}-{{ block.id }}-{{ quick_buy_context }}-{{ product.id }}{%- endcapture -%}

        

    {%- render 'variant-picker',
                  product: product,
                  form_id: product_form_id,
                  update_url: update_url,
                  hide_sold_out_variants: false,
                  selector_type: 'block',
                  color_selector_type: 'color',
                  size_chart_page: false
              -%}

    {%- render 'buy-buttons',
                product: product,
                form_id: product_form_id,
                show_payment_button: false,
               is_available: '1'
            -%}
        
    {% comment %}
        <button type="button" aria-controls="{{ quick_buy_id }}" class="button">
          <span>{{ 'product.general.choose_options' | t }}</span>
          {%- render 'icon' with 'plus' -%}
        </button>

        <quick-buy-modal handle="{{ product.handle }}" class="quick-buy-modal modal" id="{{ quick_buy_id }}">
        </quick-buy-modal>

     {% endcomment %}   
        
      {%- endif -%}
    {%- endif -%}
  </div>

  {% comment %}
  <script>

// var request = new Request(`${window.Shopify.routes.root}products/{{ product.handle }}`, {
//   method: "GET"
// });

// request.text().then((text) => {
//   console.log(text);
// });

   var url = `${window.Shopify.routes.root}products/{{ product.handle }}`;
      return fetch(url, {
        credentials: 'same-origin',
        method: 'GET'
      }).then(response => response.text()); 
  
  //  var responseContent = (fetch(`${window.Shopify.routes.root}products/{{ product.handle }}`)).text();

  // console.log(responseContent); 
</script>
   {% endcomment %} 
  
</product-card>


